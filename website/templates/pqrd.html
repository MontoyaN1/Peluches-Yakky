{% extends 'index.html' %}

{% block title %} PQRD
{% endblock %}

{% block body %}
<div class="container-fluid fondo py-5" style="min-height: 100vh;">
    <div class="row justify-content-center bg-light m-4 p-4 rounded-3">
        <!-- Header del Dashboard -->
        <div class="d-flex justify-content-between align-items-center mb-5">
            <h1 class="text-black mb-0 display-4 fw-bold">
                <i class="bi bi-card-list me-3"></i>Gestión de PQRD
            </h1>
            <div class="d-flex gap-3">
                <button onclick="window.location.href='/adminvista'" class="btn btn-primary">
                    <i class="bi bi-arrow-return-left me-2"></i>Volver
                </button>
            </div>
        </div>

        <!-- Total pqrd, abierto, en progreso y resuelto -->
        <div class="row mb-4">
            <div class="col-xl-3 col-md-6 mb-3">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div class="flex-shrink-0">
                                <div class="bg-primary bg-opacity-10 p-3 rounded">
                                    <i class="bi bi-ticket-perforated text-primary fs-4"></i>
                                </div>
                            </div>
                            <div class="flex-grow-1 ms-3">
                                <h3 class="fw-bold mb-0">{{estados.total}}</h3>
                                <p class="text-muted mb-0">PQRD Totales</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-xl-3 col-md-6 mb-3">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div class="flex-shrink-0">
                                <div class="bg-secondary bg-opacity-10 p-3 rounded">
                                    <i class="bi bi-door-open text-secondary fs-4"></i>
                                </div>
                            </div>
                            <div class="flex-grow-1 ms-3">
                                <h3 class="fw-bold mb-0">{{estados.abierto}}</h3>
                                <p class="text-muted mb-0">PQRD Abiertos</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-xl-3 col-md-6 mb-3">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div class="flex-shrink-0">
                                <div class="bg-info bg-opacity-10 p-3 rounded">
                                    <i class="bi bi-headset text-info fs-4"></i>
                                </div>
                            </div>
                            <div class="flex-grow-1 ms-3">
                                <h3 class="fw-bold mb-0">{{estados.progreso}}</h3>
                                <p class="text-muted mb-0">PQRD En progreso</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-xl-3 col-md-6 mb-3">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div class="flex-shrink-0">
                                <div class="bg-success bg-opacity-10 p-3 rounded">
                                    <i class="bi bi-check-circle-fill text-success fs-4"></i>
                                </div>
                            </div>
                            <div class="flex-grow-1 ms-3">
                                <h3 class="fw-bold mb-0"> {{estados.resuelto}}</h3>
                                <p class="text-muted mb-0">PQRD Resueltos</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sección de Tabs -->
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white border-bottom">
                <ul class="nav nav-tabs card-header-tabs" id="adminTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="tickets-tab" data-bs-toggle="tab" data-bs-target="#tickets"
                            type="button" role="tab">
                            <i class="bi bi-ticket-perforated me-2"></i>PQRD
                        </button>
                    </li>
                </ul>
            </div>

            <div class="card-body">
                <div class="tab-content" id="adminTabContent">
                    <!-- TAB: TICKETS -->
                    <div class="tab-pane fade show active" id="tickets" role="tabpanel">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h3 class="h4 mb-0">Todos los PQRD</h3>
                            <div class="d-flex gap-2">
                                <!-- Filtro por Estado -->
                                <select class="form-select form-select-sm w-auto" id="filterEstado">
                                    <option value="all">Todos los estados</option>
                                    <option value="Abierto">Abierto</option>
                                    <option value="En Progreso">En Progreso</option>
                                    <option value="Resuelto">Resuelto</option>
                                </select>

                                <!-- Filtro por Prioridad -->
                                <select class="form-select form-select-sm w-auto" id="filterPrioridad">
                                    <option value="all">Todas las prioridades</option>
                                    <option value="Alta">Alta</option>
                                    <option value="Media">Media</option>
                                    <option value="Baja">Baja</option>
                                </select>

                                <!-- Filtro por Asignación -->
                                <select class="form-select form-select-sm w-auto" id="filterAsignacion">
                                    <option value="all">Todos</option>
                                    <option value="asignados">Asignados</option>
                                    <option value="no-asignados">No asignados</option>
                                </select>

                                <!-- Botón para limpiar filtros -->
                                <button class="btn btn-outline-secondary btn-sm" id="clearFilters">
                                    <i class="bi bi-x-circle me-1"></i>Limpiar
                                </button>
                            </div>
                        </div>

                        <!-- Contador de resultados -->
                        <div class="mb-3">
                            <small class="text-muted" id="resultCount">
                                Mostrando {{ pqrds|length }} de {{ pqrds|length }} PQRD
                            </small>
                        </div>

                        <!-- Tickets Grid -->
                        <div class="row g-3" id="ticketsContainer">
                            {% for ticket in pqrds %}
                            <div class="col-xxl-4 col-lg-6 ticket-item" data-estado="{{ ticket.estado }}"
                                data-prioridad="{{ ticket.prioridad }}"
                                data-asignado="{{ 'true' if ticket.id_agente else 'false' }}">
                                <div class="card h-100 border-start border-4 
                                {{ 'border-warning' if ticket.estado == 'Abierto' }}
                                {{ 'border-info' if ticket.estado == 'En Progreso' }}
                                {{ 'border-success' if ticket.estado == 'Resuelto' }}">

                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-start mb-3">
                                            <span class="badge 
                                            {{ 'bg-warning' if ticket.estado == 'Abierto' }}
                                            {{ 'bg-info' if ticket.estado == 'En Progreso' }}
                                            {{ 'bg-success' if ticket.estado == 'Resuelto' }}">
                                                {{ ticket.estado }}
                                            </span>
                                            <span class="badge 
                                            {{ 'bg-danger' if ticket.prioridad == 'Alta' }}
                                            {{ 'bg-warning' if ticket.prioridad == 'Media' }}
                                            {{ 'bg-success' if ticket.prioridad == 'Baja' }}">
                                                {{ ticket.prioridad }}
                                            </span>
                                        </div>

                                        <h5 class="card-title fw-bold mb-2">{{ ticket.asunto }}</h5>
                                        <p class="card-text text-muted small mb-3">{{ ticket.descripcion|truncate(100)
                                            }}</p>

                                        <div class="ticket-info small text-muted mb-3">
                                            <div class="mb-1">
                                                <strong>Empleado:</strong>
                                                {% if ticket.id_agente %}
                                                <span class="badge bg-primary">#EMPLEADO-{{ticket.id_agente}}</span>
                                                {% else %}
                                                <span class="badge bg-secondary">Sin Asignar</span>
                                                {% endif %}
                                            </div>
                                            <div class="mb-1">
                                                <strong>Cliente:</strong> ID-{{ ticket.id_cliente }}
                                            </div>
                                            <div>
                                                <strong>Ticket:</strong> #TICKET-{{ ticket.id_pqrd }}
                                            </div>
                                        </div>

                                        <div class="d-flex justify-content-between align-items-center">
                                            <small class="text-muted">
                                                <i class="bi bi-calendar me-1"></i>
                                                {{ ticket.fecha_creacion.strftime('%d/%m/%Y') if ticket.fecha_creacion
                                                else 'Fecha no disponible' }}
                                            </small>

                                            {% if current_user.rol_id == 1 %}

                                            <button class="btn btn-outline-primary btn-sm" data-bs-toggle="modal"
                                                data-bs-target="#asignarTecnicoModal"
                                                data-ticket-id="{{ ticket.id_pqrd }}"
                                                data-ticket-title="{{ ticket.asunto }}">
                                                <i class="bi bi-person-plus me-1"></i>
                                                Asignar
                                            </button>

                                            {% else %}


                                            <button class="btn btn-outline-primary btn-sm" data-bs-toggle="modal"
                                                data-bs-target="#asignarTecnicoModal"
                                                data-ticket-id="{{ ticket.id_pqrd }}"
                                                data-ticket-title="{{ ticket.asunto }}">
                                                <i class="bi bi-person-plus me-1"></i>
                                                Cambiar estado
                                            </button>

                                            {% endif %}

                                            <a href="/cliente/chat/{{ticket.id_pqrd}}">Chat <i
                                                    class="bi bi-chat-left-dots"></i></a>

                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>

                        <!-- Mensaje cuando no hay resultados -->
                        <div class="text-center py-5 d-none" id="noResults">
                            <i class="bi bi-search display-1 text-muted mb-3"></i>
                            <h4 class="text-muted">No se encontraron PQRD</h4>
                            <p class="text-muted">Intenta con otros criterios de filtrado</p>
                            <button class="btn btn-primary btn-sm" id="resetFilters">
                                <i class="bi bi-arrow-clockwise me-1"></i>Mostrar todos
                            </button>
                        </div>

                        <!-- Paginación -->
                        <nav class="d-flex justify-content-center mt-4">
                            <ul class="pagination">
                                <li class="page-item disabled">
                                    <a class="page-link" href="#">
                                        <i class="bi bi-chevron-left"></i>
                                    </a>
                                </li>
                                <li class="page-item active"><a class="page-link" href="#">1</a></li>
                                <li class="page-item"><a class="page-link" href="#">2</a></li>
                                <li class="page-item"><a class="page-link" href="#">3</a></li>
                                <li class="page-item">
                                    <a class="page-link" href="#">
                                        <i class="bi bi-chevron-right"></i>
                                    </a>
                                </li>
                            </ul>
                        </nav>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: Asignar Empleado -->
    <div class="modal fade" id="asignarTecnicoModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">
                        <i class="bi bi-person-plus me-2"></i>
                        Gestionar PQRD
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    {% if current_user.rol_id == 1 %}

                    <form id="assignTechnicianForm" method="post" action="{{url_for('mvc_admin.asignar_tecnico')}}">
                        <input type="hidden" id="ticket_id" name="ticket_id">

                        <div class="row">
                            <div class="col-md-12 mb-3">
                                <label class="form-label fw-bold">PQRD Asunto</label>
                                <input type="text" class="form-control" id="ticket_display" disabled>
                            </div>
                        </div>

                        <div class="row">


                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-bold">Estado</label>
                                <select class="form-select" name="estado">
                                    <option value="Abierto" selected>Abierto</option>
                                    <option value="En Progreso">En Progreso</option>
                                    <option value="Resuelto">Resuelto</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-bold">Prioridad</label>
                                <select class="form-select" name="prioridad">
                                    <option value="Baja">Baja</option>
                                    <option value="Media" selected>Media</option>
                                    <option value="Alta">Alta</option>
                                </select>
                            </div>
                        </div>

                        <div class="row">

                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-bold">Seleccionar Empleado *</label>
                                <select class="form-select" name="tecnico_id" required>
                                    <option value="">Seleccionar empleado...</option>
                                    {% for empleado in empleados %}
                                    <option value="{{ empleado.id }}">{{ empleado.username }}</option>
                                    {% endfor %}
                                </select>
                            </div>

                        </div>

                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-check me-2"></i>
                                Asignar Empleado
                            </button>
                        </div>
                    </form>

                    {% else %}

                    <form id="assignTechnicianForm" method="post" action="{{url_for('employee.actualizar_pqrd')}}">
                        <input type="hidden" id="ticket_id" name="ticket_id">

                        <div class="row">
                            <div class="col-md-12 mb-3">
                                <label class="form-label fw-bold">PQRD Asunto</label>
                                <input type="text" class="form-control" id="ticket_display" disabled>
                            </div>
                        </div>

                        <div class="row">

                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-bold">Estado</label>
                                <select class="form-select" name="estado">
                                    <option value="Abierto" selected>Abierto</option>
                                    <option value="En Progreso">En Progreso</option>
                                    <option value="Resuelto">Resuelto</option>
                                </select>
                            </div>


                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-bold">Prioridad</label>
                                <select class="form-select" name="prioridad">
                                    <option value="Baja">Baja</option>
                                    <option value="Media" selected>Media</option>
                                    <option value="Alta">Alta</option>
                                </select>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-check me-2"></i>
                                Asignar Empleado
                            </button>
                        </div>
                    </form>

                    {% endif %}

                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .card {
        transition: transform 0.3s, box-shadow 0.3s;
    }

    .card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1) !important;
    }

    .ticket-item {
        transition: all 0.3s ease;
    }

    .ticket-item.hidden {
        display: none !important;
    }
</style>

<script>
    // Script para el modal de asignar empleado
    document.addEventListener('DOMContentLoaded', function () {
        const asignarTecnicoModal = document.getElementById('asignarTecnicoModal');

        if (asignarTecnicoModal) {
            asignarTecnicoModal.addEventListener('show.bs.modal', function (event) {
                const button = event.relatedTarget;
                const ticketId = button.getAttribute('data-ticket-id');
                const ticketTitle = button.getAttribute('data-ticket-title');

                // Actualizar el formulario
                const ticketIdInput = document.getElementById('ticket_id');
                const ticketDisplay = document.getElementById('ticket_display');

                if (ticketIdInput && ticketDisplay) {
                    ticketIdInput.value = ticketId;
                    ticketDisplay.value = ticketTitle;
                }
            });
        }

        // Sistema de Filtrado
        function aplicarFiltros() {
            const estadoFiltro = document.getElementById('filterEstado').value;
            const prioridadFiltro = document.getElementById('filterPrioridad').value;
            const asignacionFiltro = document.getElementById('filterAsignacion').value;

            const tickets = document.querySelectorAll('.ticket-item');
            let visibleCount = 0;

            tickets.forEach(ticket => {
                const estado = ticket.getAttribute('data-estado');
                const prioridad = ticket.getAttribute('data-prioridad');
                const asignado = ticket.getAttribute('data-asignado');

                let mostrar = true;

                // Filtro por estado
                if (estadoFiltro !== 'all' && estado !== estadoFiltro) {
                    mostrar = false;
                }

                // Filtro por prioridad
                if (prioridadFiltro !== 'all' && prioridad !== prioridadFiltro) {
                    mostrar = false;
                }

                // Filtro por asignación
                if (asignacionFiltro !== 'all') {
                    if (asignacionFiltro === 'asignados' && asignado === 'false') {
                        mostrar = false;
                    } else if (asignacionFiltro === 'no-asignados' && asignado === 'true') {
                        mostrar = false;
                    }
                }

                if (mostrar) {
                    ticket.classList.remove('hidden');
                    visibleCount++;
                } else {
                    ticket.classList.add('hidden');
                }
            });

            // Actualizar contador
            document.getElementById('resultCount').textContent =
                `Mostrando ${visibleCount} de ${tickets.length} PQRD`;

            // Mostrar/ocultar mensaje de no resultados
            const noResults = document.getElementById('noResults');
            if (visibleCount === 0) {
                noResults.classList.remove('d-none');
            } else {
                noResults.classList.add('d-none');
            }
        }

        // Event listeners para los filtros
        document.getElementById('filterEstado').addEventListener('change', aplicarFiltros);
        document.getElementById('filterPrioridad').addEventListener('change', aplicarFiltros);
        document.getElementById('filterAsignacion').addEventListener('change', aplicarFiltros);

        // Limpiar filtros
        document.getElementById('clearFilters').addEventListener('click', function () {
            document.getElementById('filterEstado').value = 'all';
            document.getElementById('filterPrioridad').value = 'all';
            document.getElementById('filterAsignacion').value = 'all';
            aplicarFiltros();
        });

        // Resetear filtros desde el mensaje de no resultados
        document.getElementById('resetFilters').addEventListener('click', function () {
            document.getElementById('filterEstado').value = 'all';
            document.getElementById('filterPrioridad').value = 'all';
            document.getElementById('filterAsignacion').value = 'all';
            aplicarFiltros();
        });

        // Aplicar filtros al cargar la página
        aplicarFiltros();
    });
</script>
{% endblock %}