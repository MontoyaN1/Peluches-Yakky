{% extends 'index.html' %}

{% block title %} Actividades
{% endblock %}

{% block body %}

<div class="fondo" style="min-height: 100vh; padding-top: 100px;">
    <div class="container bg-light rounded-3 p-4">
        <div class="d-flex justify-content-between align-items-center mb-5">
            <h1 class="text-black mb-0 display-4 fw-bold">
                <i class="bi bi-basket-fill fs-1 text-black m-3"></i>Actividades
            </h1>

            <div class="d-flex gap-3">
                <button onclick="window.location.href='/empleado'" class="btn btn-primary">
                    <i class="bi bi-arrow-return-left me-2"></i>Volver
                </button>
            </div>
        </div>

        <!-- Sección de Filtros -->
        <div class="card mb-4">
            <div class="card-body">
                <h5 class="card-title mb-3">
                    <i class="bi bi-funnel me-2"></i>Filtros
                </h5>
                <div class="row g-3">
                    <div class="col-md-3">
                        <label class="form-label fw-bold">Estado</label>
                        <select class="form-select" id="filterEstado">
                            <option value="all">Todos los estados</option>
                            <option value="Pendiente">Pendiente</option>
                            <option value="En seguimiento">En seguimiento</option>
                            <option value="Completado">Completado</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label fw-bold">Tipo de Actividad</label>
                        <select class="form-select" id="filterTipo">
                            <option value="all">Todos los tipos</option>
                            {% set tipos_unicos = [] %}
                            {% for actividad in actividades %}
                            {% if actividad.tipo_actividad and actividad.tipo_actividad not in tipos_unicos %}
                            {% set _ = tipos_unicos.append(actividad.tipo_actividad) %}
                            {% endif %}
                            {% endfor %}
                            {% for tipo in tipos_unicos %}
                            <option value="{{ tipo }}">{{ tipo }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label fw-bold">Fecha</label>
                        <select class="form-select" id="filterFecha">
                            <option value="all">Todas las fechas</option>
                            <option value="hoy">Hoy</option>
                            <option value="semana">Esta semana</option>
                            <option value="mes">Este mes</option>
                            <option value="pasadas">Pasadas</option>
                            <option value="futuras">Futuras</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label fw-bold">Búsqueda</label>
                        <input type="text" class="form-control" id="searchInput"
                            placeholder="Buscar por título, contacto...">
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-12">
                        <button class="btn btn-outline-secondary btn-sm" id="clearFilters">
                            <i class="bi bi-x-circle me-1"></i>Limpiar Filtros
                        </button>
                    </div>
                </div>
            </div>
        </div>

        {% if actividades | length < 1 %} <h1 class="text-black mb-0 display-4 fw-bold text-center p-5">
            <i class="bi bi-emoji-frown-fill fs-1 text-black m-3"></i> No hay Actividades
            </h1>
            {% else %}
            <!-- Contador de resultados -->
            <div class="d-flex justify-content-between align-items-center mb-3">
                <small class="text-muted" id="resultCount">
                    Mostrando <span id="visibleCount">0</span> de <span id="totalCount">0</span> actividades
                </small>
            </div>

            <div class="table-responsive-lg">
                <table class="table table-bordered table-hover table-striped align-middle">
                    <thead class="table-dark">
                        <tr>
                            <th>ID</th>
                            <th>Contacto</th>
                            <th>Agente asignado</th>
                            <th>Título</th>
                            <th>Tipo de actividad</th>
                            <th>Estado</th>
                            <th>Fecha Programada</th>
                            <th>Fecha Completada</th>
                            <th>Descripción</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="actividadesTableBody">
                        {% if current_user.rol_id == 1 %}
                        {% for item in actividades %}
                        {% set fecha = item.fecha_programada %}
                        <tr class="actividad-row" data-estado="{{ item.estado }}" data-tipo="{{ item.tipo_actividad }}"
                            data-fecha="{{ item.fecha_programada.strftime('%Y-%m-%d') if item.fecha_programada else '' }}"
                            data-search="{{ item.titulo ~ ' ' ~ item.contacto.telefono ~ ' ' ~ item.contacto.nombre ~ ' ' ~ item.descripcion }}">
                            <td>{{ item.id_actividad }}</td>
                            <td>
                                <h6 class="mb-1">{{ item.contacto.nombre }}</h6>
                                <small class="text-muted">Cel: {{ item.contacto.telefono }}</small>
                            </td>
                            <td>
                                <h6 class="mb-1">{{ item.contacto.agente.username }}</h6>
                            </td>
                            <td>{{ item.titulo }}</td>
                            <td>
                                <span class="badge bg-secondary">{{ item.tipo_actividad }}</span>
                            </td>
                            <td>
                                <span class="badge 
                                        {% if item.estado == 'Pendiente' %}bg-warning text-dark
                                        {% elif item.estado == 'En seguimiento' %}bg-info
                                        {% else %}bg-success{% endif %}">
                                    {{ item.estado }}
                                </span>
                            </td>
                            <td>
                                {% if item.fecha_programada %}
                                <span class="{% if item.estado == 'Completado' %}text-muted{% endif %}">
                                    {{ fecha.strftime('%b %d %I:%M %p').lstrip('0') }}
                                </span>
                                {% if item.estado != 'Completado' and item.fecha_programada < now %} <br><small
                                        class="text-danger">¡Vencida!</small>
                                    {% endif %}
                                    {% else %}
                                    <span class="text-muted">-</span>
                                    {% endif %}
                            </td>
                            <td>
                                {% if item.estado == 'Completado' and item.fecha_completada %}
                                <span class="badge bg-success">
                                    {{ item.fecha_completada.strftime('%d/%m/%Y') }}
                                </span>
                                {% else %}
                                <span class="text-muted">-</span>
                                {% endif %}
                            </td>
                            <td>
                                <span title="{{ item.descripcion }}">
                                    {{ item.descripcion|truncate(50) }}
                                </span>
                            </td>
                            <td>
                                {% if item.estado == "Completado" %}
                                <i class="bi bi-check-circle-fill text-success" title="Completada"></i>
                                <small class="text-muted d-block">Finalizada</small>
                                {% else %}
                                <a href="/empleado/editar-actividad/{{item.id_actividad}}"
                                    class="btn btn-sm btn-outline-primary" title="Editar">
                                    <i class="bi bi-pencil-fill"></i> Editar
                                </a>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                        {% else %}
                        {% set table_actividades = [] %}
                        {% for actividad in actividades %}
                        {% if actividad.id_agente == current_user.id %}
                        {% set _ = table_actividades.append(actividad) %}
                        {% endif %}
                        {% endfor %}

                        {% if table_actividades %}
                        {% for item in table_actividades %}
                        {% set fecha = item.fecha_programada %}
                        <tr class="actividad-row" data-estado="{{ item.estado }}" data-tipo="{{ item.tipo_actividad }}"
                            data-fecha="{{ item.fecha_programada.strftime('%Y-%m-%d') if item.fecha_programada else '' }}"
                            data-search="{{ item.titulo ~ ' ' ~ item.contacto.telefono ~ ' ' ~ item.contacto.nombre ~ ' ' ~ item.descripcion }}">
                            <td>{{ item.id_actividad }}</td>
                            <td>
                                <h6 class="mb-1">{{ item.contacto.nombre }}</h6>
                                <small class="text-muted">Cel: {{ item.contacto.telefono }}</small>
                            </td>
                            <td>
                                <h6 class="mb-1">{{ item.contacto.agente.username }}</h6>
                            </td>
                            <td>{{ item.titulo }}</td>
                            <td>
                                <span class="badge bg-secondary">{{ item.tipo_actividad }}</span>
                            </td>
                            <td>
                                <span class="badge 
                                            {% if item.estado == 'Pendiente' %}bg-warning text-dark
                                            {% elif item.estado == 'En seguimiento' %}bg-info
                                            {% else %}bg-success{% endif %}">
                                    {{ item.estado }}
                                </span>
                            </td>
                            <td>
                                {% if item.fecha_programada %}
                                <span class="{% if item.estado == 'Completado' %}text-muted{% endif %}">
                                    {{ fecha.strftime('%b %d %I:%M %p').lstrip('0') }}
                                </span>
                                {% if item.estado != 'Completado' and item.fecha_programada < now %} <br><small
                                        class="text-danger">¡Vencida!</small>
                                    {% endif %}
                                    {% else %}
                                    <span class="text-muted">-</span>
                                    {% endif %}
                            </td>
                            <td>
                                {% if item.estado == 'Completado' and item.fecha_completada %}
                                <span class="badge bg-success">
                                    {{ item.fecha_completada.strftime('%d/%m/%Y') }}
                                </span>
                                {% else %}
                                <span class="text-muted">-</span>
                                {% endif %}
                            </td>
                            <td>
                                <span title="{{ item.descripcion }}">
                                    {{ item.descripcion|truncate(50) }}
                                </span>
                            </td>
                            <td>
                                {% if item.estado == "Completado" %}
                                <i class="bi bi-check-circle-fill text-success" title="Completada"></i>
                                <small class="text-muted d-block">Finalizada</small>
                                {% else %}
                                <a href="/empleado/editar-actividad/{{item.id_actividad}}"
                                    class="btn btn-sm btn-outline-primary" title="Editar">
                                    <i class="bi bi-pencil-fill"></i> Editar
                                </a>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                        {% else %}
                        <tr>
                            <td colspan="10" class="text-center py-5">
                                <div class="py-4">
                                    <i class="bi bi-calendar-x display-4 text-muted mb-3"></i>
                                    <h4 class="text-muted">No hay actividades creadas</h4>
                                    <p class="text-muted mb-0">Las actividades que crees aparecerán aquí</p>
                                </div>
                            </td>
                        </tr>
                        {% endif %}
                        {% endif %}
                    </tbody>
                </table>
            </div>

            <!-- Paginación -->
            <nav aria-label="Paginación de actividades" class="mt-4">
                <ul class="pagination justify-content-center" id="pagination">
                    <!-- La paginación se generará con JavaScript -->
                </ul>
            </nav>
            {% endif %}
    </div>
</div>

<style>
    .actividad-row {
        transition: all 0.3s ease;
    }

    .actividad-row.hidden {
        display: none;
    }

    .page-link {
        cursor: pointer;
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const rows = document.querySelectorAll('.actividad-row');
        const filterEstado = document.getElementById('filterEstado');
        const filterTipo = document.getElementById('filterTipo');
        const filterFecha = document.getElementById('filterFecha');
        const searchInput = document.getElementById('searchInput');
        const clearFilters = document.getElementById('clearFilters');
        const resultCount = document.getElementById('resultCount');
        const visibleCount = document.getElementById('visibleCount');
        const totalCount = document.getElementById('totalCount');
        const pagination = document.getElementById('pagination');

        // Configuración de paginación
        const itemsPerPage = 10;
        let currentPage = 1;

        // Inicializar contadores
        totalCount.textContent = rows.length;

        function aplicarFiltrosYBusqueda() {
            const estadoValue = filterEstado.value;
            const tipoValue = filterTipo.value;
            const fechaValue = filterFecha.value;
            const searchValue = searchInput.value.toLowerCase();

            const hoy = new Date();
            const inicioSemana = new Date(hoy);
            inicioSemana.setDate(hoy.getDate() - hoy.getDay());
            const inicioMes = new Date(hoy.getFullYear(), hoy.getMonth(), 1);

            let visibleRows = 0;

            rows.forEach(row => {
                const estado = row.getAttribute('data-estado');
                const tipo = row.getAttribute('data-tipo');
                const fechaStr = row.getAttribute('data-fecha');
                const searchText = row.getAttribute('data-search').toLowerCase();

                let mostrar = true;

                // Filtro por estado
                if (estadoValue !== 'all' && estado !== estadoValue) {
                    mostrar = false;
                }

                // Filtro por tipo
                if (tipoValue !== 'all' && tipo !== tipoValue) {
                    mostrar = false;
                }

                // Filtro por fecha
                if (fechaValue !== 'all' && fechaStr) {
                    const fecha = new Date(fechaStr);

                    switch (fechaValue) {
                        case 'hoy':
                            if (fecha.toDateString() !== hoy.toDateString()) {
                                mostrar = false;
                            }
                            break;
                        case 'semana':
                            if (fecha < inicioSemana || fecha > hoy) {
                                mostrar = false;
                            }
                            break;
                        case 'mes':
                            if (fecha < inicioMes || fecha > hoy) {
                                mostrar = false;
                            }
                            break;
                        case 'pasadas':
                            if (fecha >= hoy) {
                                mostrar = false;
                            }
                            break;
                        case 'futuras':
                            if (fecha < hoy) {
                                mostrar = false;
                            }
                            break;
                    }
                }

                // Búsqueda
                if (searchValue && !searchText.includes(searchValue)) {
                    mostrar = false;
                }

                if (mostrar) {
                    row.classList.remove('hidden');
                    visibleRows++;
                } else {
                    row.classList.add('hidden');
                }
            });

            // Actualizar contador
            visibleCount.textContent = visibleRows;
            resultCount.textContent = `Mostrando ${visibleRows} de ${rows.length} actividades`;

            // Actualizar paginación
            actualizarPaginacion(visibleRows);

            // Mostrar primera página
            mostrarPagina(1);
        }

        function actualizarPaginacion(totalItems) {
            const totalPages = Math.ceil(totalItems / itemsPerPage);
            pagination.innerHTML = '';

            if (totalPages <= 1) {
                return;
            }

            // Botón anterior
            const prevLi = document.createElement('li');
            prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
            prevLi.innerHTML = `<a class="page-link" href="#">Anterior</a>`;
            prevLi.addEventListener('click', (e) => {
                e.preventDefault();
                if (currentPage > 1) {
                    mostrarPagina(currentPage - 1);
                }
            });
            pagination.appendChild(prevLi);

            // Números de página
            for (let i = 1; i <= totalPages; i++) {
                const pageLi = document.createElement('li');
                pageLi.className = `page-item ${i === currentPage ? 'active' : ''}`;
                pageLi.innerHTML = `<a class="page-link" href="#">${i}</a>`;
                pageLi.addEventListener('click', (e) => {
                    e.preventDefault();
                    mostrarPagina(i);
                });
                pagination.appendChild(pageLi);
            }

            // Botón siguiente
            const nextLi = document.createElement('li');
            nextLi.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
            nextLi.innerHTML = `<a class="page-link" href="#">Siguiente</a>`;
            nextLi.addEventListener('click', (e) => {
                e.preventDefault();
                if (currentPage < totalPages) {
                    mostrarPagina(currentPage + 1);
                }
            });
            pagination.appendChild(nextLi);
        }

        function mostrarPagina(page) {
            currentPage = page;
            const startIndex = (page - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;

            let visibleIndex = 0;

            rows.forEach(row => {
                if (!row.classList.contains('hidden')) {
                    if (visibleIndex >= startIndex && visibleIndex < endIndex) {
                        row.style.display = '';
                    } else {
                        row.style.display = 'none';
                    }
                    visibleIndex++;
                }
            });

            // Actualizar paginación
            actualizarPaginacion(visibleIndex);
        }

        // Event listeners
        filterEstado.addEventListener('change', aplicarFiltrosYBusqueda);
        filterTipo.addEventListener('change', aplicarFiltrosYBusqueda);
        filterFecha.addEventListener('change', aplicarFiltrosYBusqueda);
        searchInput.addEventListener('input', aplicarFiltrosYBusqueda);

        clearFilters.addEventListener('click', function () {
            filterEstado.value = 'all';
            filterTipo.value = 'all';
            filterFecha.value = 'all';
            searchInput.value = '';
            aplicarFiltrosYBusqueda();
        });

        // Inicializar
        aplicarFiltrosYBusqueda();
    });
</script>

{% endblock %}