{% extends 'index.html' %}

{% block title %} Oportunidades
{% endblock %}

{% block body %}

<div class="fondo" style="min-height: 100vh; padding-top: 100px;">
    <div class="container bg-light rounded-3 p-4">
        <div class="d-flex justify-content-between align-items-center mb-5">
            <h1 class="text-black mb-0 display-4 fw-bold">
                <i class="bi bi-basket-fill fs-1 text-black m-3"></i>Oportunidades
            </h1>

            <div class="d-flex gap-3">
                <button onclick="window.location.href='/empleado'" class="btn btn-primary">
                    <i class="bi bi-arrow-return-left me-2"></i>Volver
                </button>
            </div>
        </div>

        <!-- Sección de Filtros -->
        <div class="card mb-4">
            <div class="card-body">
                <h5 class="card-title mb-3">
                    <i class="bi bi-funnel me-2"></i>Filtros
                </h5>
                <div class="row g-3">
                    <div class="col-md-3">
                        <label class="form-label fw-bold">Etapa</label>
                        <select class="form-select" id="filterEtapa">
                            <option value="all">Todas las etapas</option>
                            <option value="Prospecto">Prospecto</option>
                            <option value="Propuesta">Propuesta</option>
                            <option value="Cierre">Cierre</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label fw-bold">Probabilidad</label>
                        <select class="form-select" id="filterProbabilidad">
                            <option value="all">Todas las probabilidades</option>
                            <option value="0-25">0% - 25%</option>
                            <option value="26-50">26% - 50%</option>
                            <option value="51-75">51% - 75%</option>
                            <option value="76-100">76% - 100%</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label fw-bold">Valor Estimado</label>
                        <select class="form-select" id="filterValor">
                            <option value="all">Todos los valores</option>
                            <option value="1">1 Estrella</option>
                            <option value="2">2 Estrellas</option>
                            <option value="3">3 Estrellas</option>
                            <option value="4">4 Estrellas</option>
                            <option value="5">5 Estrellas</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label fw-bold">Búsqueda</label>
                        <input type="text" class="form-control" id="searchInput"
                            placeholder="Buscar por título, contacto...">
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-12">
                        <button class="btn btn-outline-secondary btn-sm" id="clearFilters">
                            <i class="bi bi-x-circle me-1"></i>Limpiar Filtros
                        </button>
                    </div>
                </div>
            </div>
        </div>

        {% if oportunidades | length < 1 %} <h1 class="text-black mb-0 display-4 fw-bold text-center p-5">
            <i class="bi bi-emoji-frown-fill fs-1 text-black m-3"></i> No hay Oportunidades
            </h1>
            {% else %}
            <!-- Contador de resultados -->
            <div class="d-flex justify-content-between align-items-center mb-3">
                <small class="text-muted" id="resultCount">
                    Mostrando <span id="visibleCount">0</span> de <span id="totalCount">0</span> oportunidades
                </small>
            </div>

            <div class="table-responsive-lg">
                <table class="table table-bordered table-hover table-striped align-middle">
                    <thead class="table-dark">
                        <tr>
                            <th>ID</th>
                            <th>Contacto</th>
                            <th>Agente asignado</th>
                            <th>Título</th>
                            <th>Valor Estimado</th>
                            <th>Etapa</th>
                            <th>Probabilidad</th>
                            <th>Fecha Cierre</th>
                            <th>Descripción</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="oportunidadesTableBody">
                        {% if current_user.rol_id == 1 %}
                        {% for item in oportunidades %}
                        <tr class="oportunidad-row" data-etapa="{{ item.etapa }}"
                            data-probabilidad="{{ item.probabilidad }}" data-valor="{{ item.valor_estimado }}"
                            data-search="{{ item.titulo  }} {{ item.contacto.telefono | default('', true) }} {{ item.contacto.nombre }} {{ item.descripcion }}">
                            <td>{{ item.id_oportunidad }}</td>
                            <td>
                                <h6 class="mb-1">{{ item.contacto.nombre }}</h6>
                                <small class="text-muted">Cel: {{ item.contacto.telefono }}</small>
                            </td>
                            <td>
                                <h6 class="mb-1">{{ item.contacto.agente.username }}</h6>
                            </td>
                            <td>{{ item.titulo }}</td>
                            <td>
                                {% if item.valor_estimado %}
                                {% for i in range(1, 6) %}
                                <i class="bi bi-star{% if i <= item.valor_estimado %}-fill text-warning{% endif %}"></i>
                                {% endfor %}
                                <small class="text-muted d-block mt-1">({{ item.valor_estimado }} estrellas)</small>
                                {% else %}
                                <span class="text-muted">Sin valorar</span>
                                {% endif %}
                            </td>
                            <td>
                                <span class="badge 
                                        {% if item.etapa == 'Prospecto' %}bg-primary
                                        {% elif item.etapa == 'Propuesta' %}bg-warning text-dark
                                        {% else %}bg-success{% endif %}">
                                    {{ item.etapa }}
                                </span>
                            </td>
                            <td>
                                <div class="d-flex align-items-center">
                                    <div class="progress flex-grow-1 me-2" style="height: 8px;">
                                        <div class="progress-bar 
                                                {% if item.probabilidad <= 25 %}bg-danger
                                                {% elif item.probabilidad <= 50 %}bg-warning
                                                {% elif item.probabilidad <= 75 %}bg-info
                                                {% else %}bg-success{% endif %}"
                                            style="width: {{ item.probabilidad }}%">
                                        </div>
                                    </div>
                                    <small class="text-muted">{{ item.probabilidad }}%</small>
                                </div>
                            </td>
                            <td>
                                {% if item.etapa == 'Cierre' and item.fecha_cierre %}
                                <span class="badge bg-success">
                                    {{ item.fecha_cierre.strftime('%d/%m/%Y') }}
                                </span>
                                {% else %}
                                <span class="text-muted">-</span>
                                {% endif %}
                            </td>
                            <td>
                                <span title="{{ item.descripcion }}">
                                    {{ item.descripcion|truncate(50) }}
                                </span>
                            </td>
                            <td>
                                {% if item.etapa == "Cierre" %}
                                <i class="bi bi-check-circle-fill text-success" title="Cerrada"></i>
                                <small class="text-muted d-block">Completada</small>
                                {% else %}
                                <a href="/empleado/editar-oportunidad/{{item.id_oportunidad}}"
                                    class="btn btn-sm btn-outline-primary" title="Editar">
                                    <i class="bi bi-pencil-fill"></i> Editar
                                </a>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                        {% else %}
                        {% set table_oportunidades = [] %}
                        {% for oportunidad in oportunidades %}
                        {% if oportunidad.id_agente == current_user.id %}
                        {% set _ = table_oportunidades.append(oportunidad) %}
                        {% endif %}
                        {% endfor %}

                        {% if table_oportunidades %}
                        {% for item in table_oportunidades %}
                        <tr class="oportunidad-row" data-etapa="{{ item.etapa }}"
                            data-probabilidad="{{ item.probabilidad }}" data-valor="{{ item.valor_estimado }}"
                            data-search="{{ item.titulo ~ ' ' ~ item.contacto.telefono ~ ' ' ~ item.contacto.nombre ~ ' ' ~ item.descripcion }}">
                            <td>{{ item.id_oportunidad }}</td>
                            <td>
                                <h6 class="mb-1">{{ item.contacto.nombre }}</h6>
                                <small class="text-muted">Cel: {{ item.contacto.telefono }}</small>
                            </td>
                            <td>
                                <h6 class="mb-1">{{ item.contacto.agente.username }}</h6>
                            </td>
                            <td>{{ item.titulo }}</td>
                            <td>
                                {% if item.valor_estimado %}
                                {% for i in range(1, 6) %}
                                <i class="bi bi-star{% if i <= item.valor_estimado %}-fill text-warning{% endif %}"></i>
                                {% endfor %}
                                <small class="text-muted d-block mt-1">({{ item.valor_estimado }} estrellas)</small>
                                {% else %}
                                <span class="text-muted">Sin valorar</span>
                                {% endif %}
                            </td>
                            <td>
                                <span class="badge 
                                            {% if item.etapa == 'Prospecto' %}bg-primary
                                            {% elif item.etapa == 'Propuesta' %}bg-warning text-dark
                                            {% else %}bg-success{% endif %}">
                                    {{ item.etapa }}
                                </span>
                            </td>
                            <td>
                                <div class="d-flex align-items-center">
                                    <div class="progress flex-grow-1 me-2" style="height: 8px;">
                                        <div class="progress-bar 
                                                    {% if item.probabilidad <= 25 %}bg-danger
                                                    {% elif item.probabilidad <= 50 %}bg-warning
                                                    {% elif item.probabilidad <= 75 %}bg-info
                                                    {% else %}bg-success{% endif %}"
                                            style="width: {{ item.probabilidad }}%">
                                        </div>
                                    </div>
                                    <small class="text-muted">{{ item.probabilidad }}%</small>
                                </div>
                            </td>
                            <td>
                                {% if item.etapa == 'Cierre' and item.fecha_cierre %}
                                <span class="badge bg-success">
                                    {{ item.fecha_cierre.strftime('%d/%m/%Y') }}
                                </span>
                                {% else %}
                                <span class="text-muted">-</span>
                                {% endif %}
                            </td>
                            <td>
                                <span title="{{ item.descripcion }}">
                                    {{ item.descripcion|truncate(50) }}
                                </span>
                            </td>
                            <td>
                                {% if item.etapa == "Cierre" %}
                                <i class="bi bi-check-circle-fill text-success" title="Cerrada"></i>
                                <small class="text-muted d-block">Completada</small>
                                {% else %}
                                <a href="/empleado/editar-oportunidad/{{item.id_oportunidad}}"
                                    class="btn btn-sm btn-outline-primary" title="Editar">
                                    <i class="bi bi-pencil-fill"></i> Editar
                                </a>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                        {% else %}
                        <tr>
                            <td colspan="10" class="text-center py-5">
                                <div class="py-4">
                                    <i class="bi bi-briefcase display-4 text-muted mb-3"></i>
                                    <h4 class="text-muted">No hay oportunidades creadas</h4>
                                    <p class="text-muted mb-0">Las oportunidades que crees aparecerán aquí</p>
                                </div>
                            </td>
                        </tr>
                        {% endif %}
                        {% endif %}
                    </tbody>
                </table>
            </div>

            <!-- Paginación -->
            <nav aria-label="Paginación de oportunidades" class="mt-4">
                <ul class="pagination justify-content-center" id="pagination">
                    <!-- La paginación se generará con JavaScript -->
                </ul>
            </nav>
            {% endif %}
    </div>
</div>

<style>
    .oportunidad-row {
        transition: all 0.3s ease;
    }

    .oportunidad-row.hidden {
        display: none;
    }

    .page-link {
        cursor: pointer;
    }

    .progress {
        min-width: 80px;
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const rows = document.querySelectorAll('.oportunidad-row');
        const filterEtapa = document.getElementById('filterEtapa');
        const filterProbabilidad = document.getElementById('filterProbabilidad');
        const filterValor = document.getElementById('filterValor');
        const searchInput = document.getElementById('searchInput');
        const clearFilters = document.getElementById('clearFilters');
        const resultCount = document.getElementById('resultCount');
        const visibleCount = document.getElementById('visibleCount');
        const totalCount = document.getElementById('totalCount');
        const pagination = document.getElementById('pagination');

        // Configuración de paginación
        const itemsPerPage = 10;
        let currentPage = 1;

        // Inicializar contadores
        totalCount.textContent = rows.length;

        function aplicarFiltrosYBusqueda() {
            const etapaValue = filterEtapa.value;
            const probabilidadValue = filterProbabilidad.value;
            const valorValue = filterValor.value;
            const searchValue = searchInput.value.toLowerCase();

            let visibleRows = 0;

            rows.forEach(row => {
                const etapa = row.getAttribute('data-etapa');
                const probabilidad = parseInt(row.getAttribute('data-probabilidad'));
                const valor = row.getAttribute('data-valor');
                const searchText = row.getAttribute('data-search').toLowerCase();

                let mostrar = true;

                // Filtro por etapa
                if (etapaValue !== 'all' && etapa !== etapaValue) {
                    mostrar = false;
                }

                // Filtro por probabilidad
                if (probabilidadValue !== 'all') {
                    const [min, max] = probabilidadValue.split('-').map(Number);
                    if (probabilidad < min || probabilidad > max) {
                        mostrar = false;
                    }
                }

                // Filtro por valor estimado - CORREGIDO
                if (valorValue !== 'all') {
                    const valorFiltro = parseInt(valorValue);
                    // Si el valor en la fila está vacío o no coincide, ocultar
                    if (!valor || parseInt(valor) !== valorFiltro) {
                        mostrar = false;
                    }
                }

                // Búsqueda
                if (searchValue && !searchText.includes(searchValue)) {
                    mostrar = false;
                }

                if (mostrar) {
                    row.classList.remove('hidden');
                    visibleRows++;
                } else {
                    row.classList.add('hidden');
                }
            });

            // Actualizar contador
            visibleCount.textContent = visibleRows;
            resultCount.textContent = `Mostrando ${visibleRows} de ${rows.length} oportunidades`;

            // Actualizar paginación
            actualizarPaginacion(visibleRows);

            // Mostrar primera página
            mostrarPagina(1);
        }

        function actualizarPaginacion(totalItems) {
            const totalPages = Math.ceil(totalItems / itemsPerPage);
            pagination.innerHTML = '';

            if (totalPages <= 1) {
                return;
            }

            // Botón anterior
            const prevLi = document.createElement('li');
            prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
            prevLi.innerHTML = `<a class="page-link" href="#">Anterior</a>`;
            prevLi.addEventListener('click', (e) => {
                e.preventDefault();
                if (currentPage > 1) {
                    mostrarPagina(currentPage - 1);
                }
            });
            pagination.appendChild(prevLi);

            // Números de página
            for (let i = 1; i <= totalPages; i++) {
                const pageLi = document.createElement('li');
                pageLi.className = `page-item ${i === currentPage ? 'active' : ''}`;
                pageLi.innerHTML = `<a class="page-link" href="#">${i}</a>`;
                pageLi.addEventListener('click', (e) => {
                    e.preventDefault();
                    mostrarPagina(i);
                });
                pagination.appendChild(pageLi);
            }

            // Botón siguiente
            const nextLi = document.createElement('li');
            nextLi.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
            nextLi.innerHTML = `<a class="page-link" href="#">Siguiente</a>`;
            nextLi.addEventListener('click', (e) => {
                e.preventDefault();
                if (currentPage < totalPages) {
                    mostrarPagina(currentPage + 1);
                }
            });
            pagination.appendChild(nextLi);
        }

        function mostrarPagina(page) {
            currentPage = page;
            const startIndex = (page - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;

            let visibleIndex = 0;

            rows.forEach(row => {
                if (!row.classList.contains('hidden')) {
                    if (visibleIndex >= startIndex && visibleIndex < endIndex) {
                        row.style.display = '';
                    } else {
                        row.style.display = 'none';
                    }
                    visibleIndex++;
                }
            });

            // Actualizar paginación
            actualizarPaginacion(visibleIndex);
        }

        // Event listeners
        filterEtapa.addEventListener('change', aplicarFiltrosYBusqueda);
        filterProbabilidad.addEventListener('change', aplicarFiltrosYBusqueda);
        filterValor.addEventListener('change', aplicarFiltrosYBusqueda);
        searchInput.addEventListener('input', aplicarFiltrosYBusqueda);

        clearFilters.addEventListener('click', function () {
            filterEtapa.value = 'all';
            filterProbabilidad.value = 'all';
            filterValor.value = 'all';
            searchInput.value = '';
            aplicarFiltrosYBusqueda();
        });

        // Inicializar
        aplicarFiltrosYBusqueda();
    });
</script>

{% endblock %}