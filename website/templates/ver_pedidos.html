{% extends 'index.html' %}

{% block title %} Administración
{% endblock %}

{% block body %}

{% if pedidos | length < 1 %} <div class="fondo" style="min-height: 100vh; padding-top: 20px;">
    <div class="container bg-light rounded-3 p-2 ">
        <div class="d-flex justify-content-between align-items-center mb-5">
            <h1 class="text-black mb-0 display-4 fw-bold">
                <i class="bi bi-cart fs-1 text-black m-3"></i> Pedidos
            </h1>
            <div class="d-flex gap-3">
                <button onclick="window.location.href='/adminvista'" class="btn btn-primary">
                    <i class="bi bi-arrow-return-left me-2"></i> Volver
                </button>
            </div>
        </div>
        <h1 class="text-black mb-0 display-4 fw-bold text-center p-5">
            <i class="bi bi-emoji-frown-fill fs-1 text-black m-3"></i> No hay pedidos
        </h1>
    </div>
    </div>
    {% else %}
    <div class="fondo" style="min-height: 100vh; padding-top: 20px;">
        <div class="container bg-light rounded-3 p-4">
            <!-- Encabezado -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="text-black mb-0 fs-3 fw-bold">
                    <i class="bi bi-cart me-2"></i>Pedidos
                </h1>
                <button onclick="window.location.href='/adminvista'" class="btn btn-primary btn-sm">
                    <i class="bi bi-arrow-return-left me-1"></i>Volver
                </button>
            </div>

            <!-- Sección de Filtros -->
            <div class="card mb-4">
                <div class="card-body">
                    <h5 class="card-title mb-3">
                        <i class="bi bi-funnel me-2"></i>Filtros
                    </h5>
                    <div class="row g-3">
                        <div class="col-md-3">
                            <label class="form-label fw-bold">Estado</label>
                            <select class="form-select" id="filterEstado">
                                <option value="all">Todos los estados</option>
                                <option value="Pendiente">Pendiente</option>
                                <option value="Enviado">Enviado</option>
                                <option value="Entregado">Entregado</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label fw-bold">Forma de Pago</label>
                            <select class="form-select" id="filterPago">
                                <option value="all">Todas las formas</option>
                                {% set formas_pago_unicas = [] %}
                                {% for pedido in pedidos %}
                                {% if pedido.forma_pago and pedido.forma_pago not in formas_pago_unicas %}
                                {% set _ = formas_pago_unicas.append(pedido.forma_pago) %}
                                {% endif %}
                                {% endfor %}
                                {% for forma in formas_pago_unicas %}
                                <option value="{{ forma }}">{{ forma }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label fw-bold">Total</label>
                            <select class="form-select" id="filterTotal">
                                <option value="all">Todos los totales</option>
                                <option value="0-50000">$0 - $50.000</option>
                                <option value="50001-100000">$50.001 - $100.000</option>
                                <option value="100001-200000">$100.001 - $200.000</option>
                                <option value="200001-9999999">$200.001+</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label fw-bold">Búsqueda</label>
                            <input type="text" class="form-control" id="searchInput"
                                placeholder="Buscar por usuario, producto, email...">
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-12">
                            <button class="btn btn-outline-secondary btn-sm" id="clearFilters">
                                <i class="bi bi-x-circle me-1"></i>Limpiar Filtros
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Contador de resultados -->
            <div class="d-flex justify-content-between align-items-center mb-3">
                <small class="text-muted" id="resultCount">
                    Mostrando <span id="visibleCount">0</span> de <span id="totalCount">0</span> pedidos
                </small>
            </div>

            <!-- Tabla Scroll Horizontal -->
            <div class="table-responsive-lg rounded-3">
                <table class="table table-bordered table-hover table-striped align-middle">
                    <thead class="table-dark">
                        <tr>
                            <th class="text-nowrap">ID</th>
                            <th class="text-nowrap">Usuario</th>
                            <th class="text-nowrap">Producto</th>
                            <th class="text-nowrap">Precio</th>
                            <th class="text-nowrap">Cantidad</th>
                            <th class="text-nowrap">Total</th>
                            <th class="text-nowrap">Forma de pago</th>
                            <th class="text-nowrap">Estado</th>
                            <th class="text-nowrap">Fecha</th>
                            <th class="text-nowrap">Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="pedidosTableBody">
                        {% for item in pedidos %}
                        <tr class="pedido-row" data-estado="{{ item.status }}" data-pago="{{ item.forma_pago }}"
                            data-total="{{ item.price * item.quantity }}"
                            data-search="{{ item.customer.username ~ ' ' ~ item.customer.email ~ ' ' ~ item.product.product_name ~ ' ' ~ item.phone ~ ' ' ~ item.address }}">
                            <td>{{ item.id }}</td>
                            <td>
                                <div class="d-flex flex-column">
                                    <span class="fw-bold">{{ item.customer.username }}</span>
                                    <small class="text-muted">{{ item.customer.email }}</small>
                                    <small>{{ item.phone }}</small>
                                    <small>{{ item.address }}</small>
                                </div>
                            </td>
                            <td>
                                <div class="d-flex align-items-center">
                                    <span>{{ item.product.product_name }}</span>
                                </div>
                            </td>
                            <td>${{ item.price }}</td>
                            <td>{{ item.quantity }}</td>
                            <td class="fw-bold">${{ item.price * item.quantity }}</td>
                            <td>{{ item.forma_pago }}</td>
                            <td>
                                <span class="badge 
                                {% if item.status == 'Entregado' %}bg-success
                                {% elif item.status == 'Enviado' %}bg-warning text-black
                                {% else %}bg-primary{% endif %}">
                                    {{ item.status }}
                                </span>
                            </td>
                            <td class="text-nowrap">{{ item.fecha_creacion.strftime('%d/%m/%Y') }}</td>
                            <td>

                                {% if item.status == 'Entregado' %}
                                <i class="bi bi-check-circle-fill text-success" title="Completada"></i>
                                <small class="text-muted d-block">Finalizada</small>

                                {% else %}

                                <a href="/actua-pedido/{{ item.id }}" class="btn btn-sm btn-outline-primary">
                                    <i class="bi bi-pencil-square"></i> Editar
                                </a>

                                {% endif %}

                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <!-- Paginación -->
            <nav aria-label="Paginación de pedidos" class="mt-4">
                <ul class="pagination justify-content-center" id="pagination">
                    <!-- La paginación se generará con JavaScript -->
                </ul>
            </nav>
        </div>
    </div>

    <style>
        .table-responsive-lg {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        .img-thumbnail {
            padding: 0.15rem;
            background-color: #fff;
        }

        .fondo {
            background-color: #f8f9fa;
        }

        .pedido-row {
            transition: all 0.3s ease;
        }

        .pedido-row.hidden {
            display: none;
        }

        .page-link {
            cursor: pointer;
        }
    </style>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const rows = document.querySelectorAll('.pedido-row');
            const filterEstado = document.getElementById('filterEstado');
            const filterPago = document.getElementById('filterPago');
            const filterTotal = document.getElementById('filterTotal');
            const searchInput = document.getElementById('searchInput');
            const clearFilters = document.getElementById('clearFilters');
            const resultCount = document.getElementById('resultCount');
            const visibleCount = document.getElementById('visibleCount');
            const totalCount = document.getElementById('totalCount');
            const pagination = document.getElementById('pagination');

            // Configuración de paginación
            const itemsPerPage = 10;
            let currentPage = 1;

            // Inicializar contadores
            totalCount.textContent = rows.length;

            function aplicarFiltrosYBusqueda() {
                const estadoValue = filterEstado.value;
                const pagoValue = filterPago.value;
                const totalValue = filterTotal.value;
                const searchValue = searchInput.value.toLowerCase();

                let visibleRows = 0;

                rows.forEach(row => {
                    const estado = row.getAttribute('data-estado');
                    const pago = row.getAttribute('data-pago');
                    const total = parseFloat(row.getAttribute('data-total'));
                    const searchText = row.getAttribute('data-search').toLowerCase();

                    let mostrar = true;

                    // Filtro por estado
                    if (estadoValue !== 'all' && estado !== estadoValue) {
                        mostrar = false;
                    }

                    // Filtro por forma de pago
                    if (pagoValue !== 'all' && pago !== pagoValue) {
                        mostrar = false;
                    }

                    // Filtro por total
                    if (totalValue !== 'all') {
                        const [min, max] = totalValue.split('-').map(Number);
                        if (total < min || total > max) {
                            mostrar = false;
                        }
                    }

                    // Búsqueda
                    if (searchValue && !searchText.includes(searchValue)) {
                        mostrar = false;
                    }

                    if (mostrar) {
                        row.classList.remove('hidden');
                        visibleRows++;
                    } else {
                        row.classList.add('hidden');
                    }
                });

                // Actualizar contador
                visibleCount.textContent = visibleRows;
                resultCount.textContent = `Mostrando ${visibleRows} de ${rows.length} pedidos`;

                // Actualizar paginación
                actualizarPaginacion(visibleRows);

                // Mostrar primera página
                mostrarPagina(1);
            }

            function actualizarPaginacion(totalItems) {
                const totalPages = Math.ceil(totalItems / itemsPerPage);
                pagination.innerHTML = '';

                if (totalPages <= 1) {
                    return;
                }

                // Botón anterior
                const prevLi = document.createElement('li');
                prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
                prevLi.innerHTML = `<a class="page-link" href="#">Anterior</a>`;
                prevLi.addEventListener('click', (e) => {
                    e.preventDefault();
                    if (currentPage > 1) {
                        mostrarPagina(currentPage - 1);
                    }
                });
                pagination.appendChild(prevLi);

                // Números de página
                for (let i = 1; i <= totalPages; i++) {
                    const pageLi = document.createElement('li');
                    pageLi.className = `page-item ${i === currentPage ? 'active' : ''}`;
                    pageLi.innerHTML = `<a class="page-link" href="#">${i}</a>`;
                    pageLi.addEventListener('click', (e) => {
                        e.preventDefault();
                        mostrarPagina(i);
                    });
                    pagination.appendChild(pageLi);
                }

                // Botón siguiente
                const nextLi = document.createElement('li');
                nextLi.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
                nextLi.innerHTML = `<a class="page-link" href="#">Siguiente</a>`;
                nextLi.addEventListener('click', (e) => {
                    e.preventDefault();
                    if (currentPage < totalPages) {
                        mostrarPagina(currentPage + 1);
                    }
                });
                pagination.appendChild(nextLi);
            }

            function mostrarPagina(page) {
                currentPage = page;
                const startIndex = (page - 1) * itemsPerPage;
                const endIndex = startIndex + itemsPerPage;

                let visibleIndex = 0;

                rows.forEach(row => {
                    if (!row.classList.contains('hidden')) {
                        if (visibleIndex >= startIndex && visibleIndex < endIndex) {
                            row.style.display = '';
                        } else {
                            row.style.display = 'none';
                        }
                        visibleIndex++;
                    }
                });

                // Actualizar paginación
                actualizarPaginacion(visibleIndex);
            }

            // Event listeners
            filterEstado.addEventListener('change', aplicarFiltrosYBusqueda);
            filterPago.addEventListener('change', aplicarFiltrosYBusqueda);
            filterTotal.addEventListener('change', aplicarFiltrosYBusqueda);
            searchInput.addEventListener('input', aplicarFiltrosYBusqueda);

            clearFilters.addEventListener('click', function () {
                filterEstado.value = 'all';
                filterPago.value = 'all';
                filterTotal.value = 'all';
                searchInput.value = '';
                aplicarFiltrosYBusqueda();
            });

            // Inicializar
            aplicarFiltrosYBusqueda();
        });
    </script>
    {% endif %}
    {% endblock %}