{% extends 'index.html' %}

{% block title %} Interacciones
{% endblock %}

{% block body %}

<div class="fondo" style="min-height: 100vh; padding-top: 100px;">
    <div class="container bg-light rounded-3 p-4">
        <div class="d-flex justify-content-between align-items-center mb-5">
            <h1 class="text-black mb-0 display-4 fw-bold">
                <i class="bi bi-basket-fill fs-1 text-black m-3"></i>Interacciones
            </h1>

            <div class="d-flex gap-3">
                <button onclick="window.location.href='/empleado'" class="btn btn-primary">
                    <i class="bi bi-arrow-return-left me-2"></i>Volver
                </button>
            </div>
        </div>

        <!-- Sección de Filtros -->
        <div class="card mb-4">
            <div class="card-body">
                <h5 class="card-title mb-3">
                    <i class="bi bi-funnel me-2"></i>Filtros
                </h5>
                <div class="row g-3">
                    <div class="col-md-4">
                        <label class="form-label fw-bold">Tipo de Interacción</label>
                        <select class="form-select" id="filterTipo">
                            <option value="all">Todos los tipos</option>
                            {% set tipos_unicos = [] %}
                            {% for interaccion in interacciones %}
                            {% if interaccion.tipo_interaccion and interaccion.tipo_interaccion not in tipos_unicos %}
                            {% set _ = tipos_unicos.append(interaccion.tipo_interaccion) %}
                            {% endif %}
                            {% endfor %}
                            {% for tipo in tipos_unicos %}
                            <option value="{{ tipo }}">{{ tipo }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label fw-bold">Fecha</label>
                        <select class="form-select" id="filterFecha">
                            <option value="all">Todas las fechas</option>
                            <option value="hoy">Hoy</option>
                            <option value="semana">Esta semana</option>
                            <option value="mes">Este mes</option>
                            <option value="antiguas">Antiguas</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label fw-bold">Búsqueda</label>
                        <input type="text" class="form-control" id="searchInput"
                            placeholder="Buscar por contacto, celular, descripción...">
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-12">
                        <button class="btn btn-outline-secondary btn-sm" id="clearFilters">
                            <i class="bi bi-x-circle me-1"></i>Limpiar Filtros
                        </button>
                    </div>
                </div>
            </div>
        </div>

        {% if interacciones | length < 1 %} <h1 class="text-black mb-0 display-4 fw-bold text-center p-5">
            <i class="bi bi-emoji-frown-fill fs-1 text-black m-3"></i> No hay Interacciones
            </h1>
            {% else %}
            <!-- Contador de resultados -->
            <div class="d-flex justify-content-between align-items-center mb-3">
                <small class="text-muted" id="resultCount">
                    Mostrando <span id="visibleCount">0</span> de <span id="totalCount">0</span> interacciones
                </small>
            </div>

            <div class="table-responsive-lg">
                <table class="table table-bordered table-hover table-striped align-middle">
                    <thead class="table-dark">
                        <tr>
                            <th>ID</th>
                            <th>Contacto</th>
                            <th>Agente asignado</th>
                            <th>Tipo de interacción</th>
                            <th>Descripción</th>
                            <th>Resultado</th>
                            <th>Fecha</th>
                        </tr>
                    </thead>
                    <tbody id="interaccionesTableBody">
                        {% if current_user.rol_id == 1 %}
                        {% for item in interacciones %}
                        <tr class="interaccion-row" data-tipo="{{ item.tipo_interaccion }}"
                            data-fecha="{{ item.fecha_interaccion.strftime('%Y-%m-%d') if item.fecha_interaccion else '' }}"
                            data-search="{{ item.contacto.nombre ~ ' ' ~ item.contacto.telefono ~ ' ' ~ item.descripcion ~ ' ' ~ item.resultado }}">
                            <td>{{ item.id_interaccion }}</td>
                            <td>
                                <h6 class="mb-1">{{ item.contacto.nombre }}</h6>
                                <small class="text-muted">Cel: {{ item.contacto.telefono }}</small>
                            </td>
                            <td>
                                <h6 class="mb-1">{{ item.contacto.agente.username }}</h6>
                            </td>
                            <td>
                                <span class="badge 
                                        {% if item.tipo_interaccion == 'Llamada' %}bg-primary
                                        {% elif item.tipo_interaccion == 'Email' %}bg-info
                                        {% elif item.tipo_interaccion == 'Reunión' %}bg-warning text-dark
                                        {% elif item.tipo_interaccion == 'Mensaje' %}bg-secondary
                                        {% else %}bg-light text-dark{% endif %}">
                                    {{ item.tipo_interaccion }}
                                </span>
                            </td>
                            <td>
                                <span title="{{ item.descripcion }}">
                                    {{ item.descripcion|truncate(80) }}
                                </span>
                            </td>
                            <td>
                                {% if item.resultado %}
                                <span class="badge 
                                            {% if 'positivo' in item.resultado.lower() %}bg-success
                                            {% elif 'negativo' in item.resultado.lower() %}bg-danger
                                            {% elif 'pendiente' in item.resultado.lower() %}bg-warning text-dark
                                            {% elif 'programado' in item.resultado.lower() %}bg-info
                                            {% else %}bg-light text-dark{% endif %}">
                                    {{ item.resultado }}
                                </span>
                                {% else %}
                                <span class="text-muted">Sin resultado</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if item.fecha_interaccion %}
                                <small class="text-muted">
                                    {{ item.fecha_interaccion.strftime('%d/%m/%Y %H:%M') }}
                                </small>
                                {% else %}
                                <span class="text-muted">-</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                        {% else %}
                        {% set table_interacciones = [] %}
                        {% for interaccion in interacciones %}
                        {% if interaccion.id_agente == current_user.id %}
                        {% set _ = table_interacciones.append(interaccion) %}
                        {% endif %}
                        {% endfor %}

                        {% if table_interacciones %}
                        {% for item in table_interacciones %}
                        <tr class="interaccion-row" data-tipo="{{ item.tipo_interaccion }}"
                            data-fecha="{{ item.fecha_interaccion.strftime('%Y-%m-%d') if item.fecha_interaccion else '' }}"
                            data-search="{{ item.contacto.nombre ~ ' ' ~ item.contacto.telefono ~ ' ' ~ item.descripcion ~ ' ' ~ item.resultado }}">
                            <td>{{ item.id_interaccion }}</td>
                            <td>
                                <h6 class="mb-1">{{ item.contacto.nombre }}</h6>
                                <small class="text-muted">Cel: {{ item.contacto.telefono }}</small>
                            </td>
                            <td>
                                <h6 class="mb-1">{{ item.contacto.agente.username }}</h6>
                            </td>
                            <td>
                                <span class="badge 
                                            {% if item.tipo_interaccion == 'Llamada' %}bg-primary
                                            {% elif item.tipo_interaccion == 'Email' %}bg-info
                                            {% elif item.tipo_interaccion == 'Reunión' %}bg-warning text-dark
                                            {% elif item.tipo_interaccion == 'Mensaje' %}bg-secondary
                                            {% else %}bg-light text-dark{% endif %}">
                                    {{ item.tipo_interaccion }}
                                </span>
                            </td>
                            <td>
                                <span title="{{ item.descripcion }}">
                                    {{ item.descripcion|truncate(80) }}
                                </span>
                            </td>
                            <td>
                                {% if item.resultado %}
                                <span class="badge 
                                            {% if 'positivo' in item.resultado.lower() %}bg-success
                                            {% elif 'negativo' in item.resultado.lower() %}bg-danger
                                            {% elif 'pendiente' in item.resultado.lower() %}bg-warning text-dark
                                            {% elif 'programado' in item.resultado.lower() %}bg-info
                                            {% else %}bg-light text-dark{% endif %}">
                                    {{ item.resultado }}
                                </span>
                                {% else %}
                                <span class="text-muted">Sin resultado</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if item.fecha_interaccion %}
                                <small class="text-muted">
                                    {{ item.fecha_interaccion.strftime('%d/%m/%Y %H:%M') }}
                                </small>
                                {% else %}
                                <span class="text-muted">-</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                        {% else %}
                        <tr>
                            <td colspan="7" class="text-center py-5">
                                <div class="py-4">
                                    <i class="bi bi-chat-left-text display-4 text-muted mb-3"></i>
                                    <h4 class="text-muted">No hay interacciones creadas</h4>
                                    <p class="text-muted mb-0">Las interacciones que crees aparecerán aquí</p>
                                </div>
                            </td>
                        </tr>
                        {% endif %}
                        {% endif %}
                    </tbody>
                </table>
            </div>

            <!-- Paginación -->
            <nav aria-label="Paginación de interacciones" class="mt-4">
                <ul class="pagination justify-content-center" id="pagination">
                    <!-- La paginación se generará con JavaScript -->
                </ul>
            </nav>
            {% endif %}
    </div>
</div>

<style>
    .interaccion-row {
        transition: all 0.3s ease;
    }

    .interaccion-row.hidden {
        display: none;
    }

    .page-link {
        cursor: pointer;
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const rows = document.querySelectorAll('.interaccion-row');
        const filterTipo = document.getElementById('filterTipo');
        const filterFecha = document.getElementById('filterFecha');
        const searchInput = document.getElementById('searchInput');
        const clearFilters = document.getElementById('clearFilters');
        const resultCount = document.getElementById('resultCount');
        const visibleCount = document.getElementById('visibleCount');
        const totalCount = document.getElementById('totalCount');
        const pagination = document.getElementById('pagination');

        // Configuración de paginación
        const itemsPerPage = 10;
        let currentPage = 1;

        // Inicializar contadores
        totalCount.textContent = rows.length;

        function aplicarFiltrosYBusqueda() {
            const tipoValue = filterTipo.value;
            const fechaValue = filterFecha.value;
            const searchValue = searchInput.value.toLowerCase();

            const hoy = new Date();
            const inicioSemana = new Date(hoy);
            inicioSemana.setDate(hoy.getDate() - hoy.getDay());
            const inicioMes = new Date(hoy.getFullYear(), hoy.getMonth(), 1);

            let visibleRows = 0;

            rows.forEach(row => {
                const tipo = row.getAttribute('data-tipo');
                const fechaStr = row.getAttribute('data-fecha');
                const searchText = row.getAttribute('data-search').toLowerCase();

                let mostrar = true;

                // Filtro por tipo
                if (tipoValue !== 'all' && tipo !== tipoValue) {
                    mostrar = false;
                }

                // Filtro por fecha
                if (fechaValue !== 'all' && fechaStr) {
                    const fecha = new Date(fechaStr);

                    switch (fechaValue) {
                        case 'hoy':
                            if (fecha.toDateString() !== hoy.toDateString()) {
                                mostrar = false;
                            }
                            break;
                        case 'semana':
                            if (fecha < inicioSemana || fecha > hoy) {
                                mostrar = false;
                            }
                            break;
                        case 'mes':
                            if (fecha < inicioMes || fecha > hoy) {
                                mostrar = false;
                            }
                            break;
                        case 'antiguas':
                            const haceUnMes = new Date();
                            haceUnMes.setMonth(haceUnMes.getMonth() - 1);
                            if (fecha >= haceUnMes) {
                                mostrar = false;
                            }
                            break;
                    }
                }

                // Búsqueda - ahora incluye números y celular
                if (searchValue && !searchText.includes(searchValue)) {
                    mostrar = false;
                }

                if (mostrar) {
                    row.classList.remove('hidden');
                    visibleRows++;
                } else {
                    row.classList.add('hidden');
                }
            });

            // Actualizar contador
            visibleCount.textContent = visibleRows;
            resultCount.textContent = `Mostrando ${visibleRows} de ${rows.length} interacciones`;

            // Actualizar paginación
            actualizarPaginacion(visibleRows);

            // Mostrar primera página
            mostrarPagina(1);
        }

        function actualizarPaginacion(totalItems) {
            const totalPages = Math.ceil(totalItems / itemsPerPage);
            pagination.innerHTML = '';

            if (totalPages <= 1) {
                return;
            }

            // Botón anterior
            const prevLi = document.createElement('li');
            prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
            prevLi.innerHTML = `<a class="page-link" href="#">Anterior</a>`;
            prevLi.addEventListener('click', (e) => {
                e.preventDefault();
                if (currentPage > 1) {
                    mostrarPagina(currentPage - 1);
                }
            });
            pagination.appendChild(prevLi);

            // Números de página
            for (let i = 1; i <= totalPages; i++) {
                const pageLi = document.createElement('li');
                pageLi.className = `page-item ${i === currentPage ? 'active' : ''}`;
                pageLi.innerHTML = `<a class="page-link" href="#">${i}</a>`;
                pageLi.addEventListener('click', (e) => {
                    e.preventDefault();
                    mostrarPagina(i);
                });
                pagination.appendChild(pageLi);
            }

            // Botón siguiente
            const nextLi = document.createElement('li');
            nextLi.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
            nextLi.innerHTML = `<a class="page-link" href="#">Siguiente</a>`;
            nextLi.addEventListener('click', (e) => {
                e.preventDefault();
                if (currentPage < totalPages) {
                    mostrarPagina(currentPage + 1);
                }
            });
            pagination.appendChild(nextLi);
        }

        function mostrarPagina(page) {
            currentPage = page;
            const startIndex = (page - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;

            let visibleIndex = 0;

            rows.forEach(row => {
                if (!row.classList.contains('hidden')) {
                    if (visibleIndex >= startIndex && visibleIndex < endIndex) {
                        row.style.display = '';
                    } else {
                        row.style.display = 'none';
                    }
                    visibleIndex++;
                }
            });

            // Actualizar paginación
            actualizarPaginacion(visibleIndex);
        }

        // Event listeners
        filterTipo.addEventListener('change', aplicarFiltrosYBusqueda);
        filterFecha.addEventListener('change', aplicarFiltrosYBusqueda);
        searchInput.addEventListener('input', aplicarFiltrosYBusqueda);

        clearFilters.addEventListener('click', function () {
            filterTipo.value = 'all';
            filterFecha.value = 'all';
            searchInput.value = '';
            aplicarFiltrosYBusqueda();
        });

        // Inicializar
        aplicarFiltrosYBusqueda();
    });
</script>

{% endblock %}