{% extends 'index.html' %}

{% block title %} Administración
{% endblock %}

{% block body %}

{% if usuarios | length < 1 %}
<div class="fondo" style="min-height: 100vh; padding-top: 20px;">
    <div class="container bg-light rounded-3 p-2 ">
        <div class="d-flex justify-content-between align-items-center mb-5">
            <h1 class="text-black mb-0 display-4 fw-bold">
                <i class="bi bi-people fs-1 text-black m-3"></i> Usuarios
            </h1>
            <div class="d-flex gap-3">
                <button onclick="window.location.href='/adminvista'" class="btn btn-primary">
                    <i class="bi bi-arrow-return-left me-2"></i> Volver
                </button>
            </div>
        </div>
        <h1 class="text-black mb-0 display-4 fw-bold text-center p-5">
            <i class="bi bi-emoji-frown-fill fs-1 text-black m-3"></i> No hay usuarios
        </h1>
    </div>
</div>
{% else %}
<div class="fondo" style="min-height: 100vh; padding-top: 20px;">
    <div class="container bg-light rounded-3 p-4 ">
        <div class="d-flex justify-content-between align-items-center mb-5">
            <h1 class="text-black mb-0 display-4 fw-bold">
                <i class="bi bi-people fs-1 text-black"></i> Usuarios
            </h1>
            <div class="d-flex gap-3">
                <button onclick="history.back()" class="btn btn-primary">
                    <i class="bi bi-arrow-return-left me-2"></i>Volver
                </button>
            </div>
        </div>

        <!-- Sección de Filtros -->
        <div class="card mb-4">
            <div class="card-body">
                <h5 class="card-title mb-3">
                    <i class="bi bi-funnel me-2"></i>Filtros
                </h5>
                <div class="row g-3">
                    <div class="col-md-3">
                        <label class="form-label fw-bold">Rol</label>
                        <select class="form-select" id="filterRol">
                            <option value="all">Todos los roles</option>
                            <option value="Empleado">Empleado</option>
                            <option value="Cliente">Cliente</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label fw-bold">Estado Teléfono</label>
                        <select class="form-select" id="filterTelefono">
                            <option value="all">Todos</option>
                            <option value="con_telefono">Con teléfono</option>
                            <option value="sin_telefono">Sin teléfono</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label fw-bold">Fecha Registro</label>
                        <select class="form-select" id="filterFecha">
                            <option value="all">Todas las fechas</option>
                            <option value="hoy">Hoy</option>
                            <option value="semana">Esta semana</option>
                            <option value="mes">Este mes</option>
                            <option value="antiguos">Antiguos</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label fw-bold">Búsqueda</label>
                        <input type="text" class="form-control" id="searchInput" placeholder="Buscar por nombre, email, teléfono...">
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-12">
                        <button class="btn btn-outline-secondary btn-sm" id="clearFilters">
                            <i class="bi bi-x-circle me-1"></i>Limpiar Filtros
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Contador de resultados -->
        <div class="d-flex justify-content-between align-items-center mb-3">
            <small class="text-muted" id="resultCount">
                Mostrando <span id="visibleCount">0</span> de <span id="totalCount">0</span> usuarios
            </small>
        </div>

        <div class="table-responsive-lg">
            <table class="table table-bordered table-hover table-striped align-middle m-2">
                <thead class="table-dark">
                    <tr>
                        <th>ID</th>
                        <th>Rol</th>
                        <th>Nombre usuario</th>
                        <th>Correo</th>
                        <th>Teléfono</th>
                        <th>Fecha de inscripción</th>
                    </tr>
                </thead>
                <tbody id="usuariosTableBody">
                    {% for item in usuarios %}
                    <tr class="usuario-row" 
                        data-rol="{{ 'Empleado' if item.rol_id == 2 else 'Cliente' }}"
                        data-telefono="{{ 'si' if item.telefono else 'no' }}"
                        data-fecha="{{ item.date_joined.strftime('%Y-%m-%d') if item.date_joined else '' }}"
                        data-search="{{ item.username ~ ' ' ~ item.email ~ ' ' ~ (item.telefono | default('', true)) }}">
                        <td>{{ item.id }}</td>
                        <td>
                            {% if item.rol_id == 2 %}
                                <span class="badge bg-primary">Empleado</span>
                            {% else %}
                                <span class="badge bg-secondary">Cliente</span>
                            {% endif %}
                        </td>
                        <td>{{ item.username }}</td>
                        <td>{{ item.email }}</td>
                        <td>
                            {% if item.telefono %}
                                <span class="text-success">{{ item.telefono }}</span>
                            {% else %}
                                <span class="text-muted">No registrado</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if item.date_joined %}
                                <small class="text-muted">
                                    {{ item.date_joined.strftime('%d/%m/%Y %H:%M') }}
                                </small>
                            {% else %}
                                <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Paginación -->
        <nav aria-label="Paginación de usuarios" class="mt-4">
            <ul class="pagination justify-content-center" id="pagination">
                <!-- La paginación se generará con JavaScript -->
            </ul>
        </nav>
    </div>
</div>

<style>
    .usuario-row {
        transition: all 0.3s ease;
    }
    
    .usuario-row.hidden {
        display: none;
    }
    
    .page-link {
        cursor: pointer;
    }
    
    .fondo {
        background-color: #f8f9fa;
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const rows = document.querySelectorAll('.usuario-row');
        const filterRol = document.getElementById('filterRol');
        const filterTelefono = document.getElementById('filterTelefono');
        const filterFecha = document.getElementById('filterFecha');
        const searchInput = document.getElementById('searchInput');
        const clearFilters = document.getElementById('clearFilters');
        const resultCount = document.getElementById('resultCount');
        const visibleCount = document.getElementById('visibleCount');
        const totalCount = document.getElementById('totalCount');
        const pagination = document.getElementById('pagination');
        
        // Configuración de paginación
        const itemsPerPage = 10;
        let currentPage = 1;
        
        // Inicializar contadores
        totalCount.textContent = rows.length;
        
        function aplicarFiltrosYBusqueda() {
            const rolValue = filterRol.value;
            const telefonoValue = filterTelefono.value;
            const fechaValue = filterFecha.value;
            const searchValue = searchInput.value.toLowerCase();
            
            const hoy = new Date();
            const inicioSemana = new Date(hoy);
            inicioSemana.setDate(hoy.getDate() - hoy.getDay());
            const inicioMes = new Date(hoy.getFullYear(), hoy.getMonth(), 1);
            
            let visibleRows = 0;
            
            rows.forEach(row => {
                const rol = row.getAttribute('data-rol');
                const telefono = row.getAttribute('data-telefono');
                const fechaStr = row.getAttribute('data-fecha');
                const searchText = row.getAttribute('data-search').toLowerCase();
                
                let mostrar = true;
                
                // Filtro por rol
                if (rolValue !== 'all' && rol !== rolValue) {
                    mostrar = false;
                }
                
                // Filtro por teléfono
                if (telefonoValue !== 'all') {
                    if (telefonoValue === 'con_telefono' && telefono === 'no') {
                        mostrar = false;
                    } else if (telefonoValue === 'sin_telefono' && telefono === 'si') {
                        mostrar = false;
                    }
                }
                
                // Filtro por fecha
                if (fechaValue !== 'all' && fechaStr) {
                    const fecha = new Date(fechaStr);
                    
                    switch(fechaValue) {
                        case 'hoy':
                            if (fecha.toDateString() !== hoy.toDateString()) {
                                mostrar = false;
                            }
                            break;
                        case 'semana':
                            if (fecha < inicioSemana || fecha > hoy) {
                                mostrar = false;
                            }
                            break;
                        case 'mes':
                            if (fecha < inicioMes || fecha > hoy) {
                                mostrar = false;
                            }
                            break;
                        case 'antiguos':
                            const haceUnMes = new Date();
                            haceUnMes.setMonth(haceUnMes.getMonth() - 1);
                            if (fecha >= haceUnMes) {
                                mostrar = false;
                            }
                            break;
                    }
                }
                
                // Búsqueda
                if (searchValue && !searchText.includes(searchValue)) {
                    mostrar = false;
                }
                
                if (mostrar) {
                    row.classList.remove('hidden');
                    visibleRows++;
                } else {
                    row.classList.add('hidden');
                }
            });
            
            // Actualizar contador
            visibleCount.textContent = visibleRows;
            resultCount.textContent = `Mostrando ${visibleRows} de ${rows.length} usuarios`;
            
            // Actualizar paginación
            actualizarPaginacion(visibleRows);
            
            // Mostrar primera página
            mostrarPagina(1);
        }
        
        function actualizarPaginacion(totalItems) {
            const totalPages = Math.ceil(totalItems / itemsPerPage);
            pagination.innerHTML = '';
            
            if (totalPages <= 1) {
                return;
            }
            
            // Botón anterior
            const prevLi = document.createElement('li');
            prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
            prevLi.innerHTML = `<a class="page-link" href="#">Anterior</a>`;
            prevLi.addEventListener('click', (e) => {
                e.preventDefault();
                if (currentPage > 1) {
                    mostrarPagina(currentPage - 1);
                }
            });
            pagination.appendChild(prevLi);
            
            // Números de página
            for (let i = 1; i <= totalPages; i++) {
                const pageLi = document.createElement('li');
                pageLi.className = `page-item ${i === currentPage ? 'active' : ''}`;
                pageLi.innerHTML = `<a class="page-link" href="#">${i}</a>`;
                pageLi.addEventListener('click', (e) => {
                    e.preventDefault();
                    mostrarPagina(i);
                });
                pagination.appendChild(pageLi);
            }
            
            // Botón siguiente
            const nextLi = document.createElement('li');
            nextLi.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
            nextLi.innerHTML = `<a class="page-link" href="#">Siguiente</a>`;
            nextLi.addEventListener('click', (e) => {
                e.preventDefault();
                if (currentPage < totalPages) {
                    mostrarPagina(currentPage + 1);
                }
            });
            pagination.appendChild(nextLi);
        }
        
        function mostrarPagina(page) {
            currentPage = page;
            const startIndex = (page - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            
            let visibleIndex = 0;
            
            rows.forEach(row => {
                if (!row.classList.contains('hidden')) {
                    if (visibleIndex >= startIndex && visibleIndex < endIndex) {
                        row.style.display = '';
                    } else {
                        row.style.display = 'none';
                    }
                    visibleIndex++;
                }
            });
            
            // Actualizar paginación
            actualizarPaginacion(visibleIndex);
        }
        
        // Event listeners
        filterRol.addEventListener('change', aplicarFiltrosYBusqueda);
        filterTelefono.addEventListener('change', aplicarFiltrosYBusqueda);
        filterFecha.addEventListener('change', aplicarFiltrosYBusqueda);
        searchInput.addEventListener('input', aplicarFiltrosYBusqueda);
        
        clearFilters.addEventListener('click', function() {
            filterRol.value = 'all';
            filterTelefono.value = 'all';
            filterFecha.value = 'all';
            searchInput.value = '';
            aplicarFiltrosYBusqueda();
        });
        
        // Inicializar
        aplicarFiltrosYBusqueda();
    });
</script>
{% endif %}
{% endblock %}