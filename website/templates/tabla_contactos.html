{% extends 'index.html' %}

{% block title %} Contactos
{% endblock %}

{% block body %}

<div class="fondo p-5" style="min-height: 100vh; ">
    <div class="container bg-light rounded-3 p-4">
        <div class="d-flex justify-content-between align-items-center mb-5">
            <h1 class="text-black mb-0 display-4 fw-bold">
                <i class="bi bi-basket-fill fs-1 text-black m-3"></i>Contactos
            </h1>

            <div class="d-flex gap-3">
                <button onclick="window.location.href='/empleado'" class="btn btn-primary">
                    <i class="bi bi-arrow-return-left me-2"></i>Volver
                </button>
                <button onclick="window.location.href='/empleado/crear_contacto'" class="btn btn-primary">
                    <i class="bi bi-person-plus me-2"></i>Nuevo Contacto
                </button>
            </div>
        </div>

        <!-- Sección de Filtros -->
        <div class="card mb-4">
            <div class="card-body">
                <h5 class="card-title mb-3">
                    <i class="bi bi-funnel me-2"></i>Filtros
                </h5>
                <div class="row g-3">
                    <div class="col-md-3">
                        <label class="form-label fw-bold">Estado</label>
                        <select class="form-select" id="filterEstado">
                            <option value="all">Todos los estados</option>
                            <option value="Nuevo">Nuevo</option>
                            <option value="En seguimiento">En seguimiento</option>
                            <option value="Cliente">Cliente</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label fw-bold">Canal</label>
                        <select class="form-select" id="filterCanal">
                            <option value="all">Todos los canales</option>
                            {% set canales_unicos = [] %}
                            {% for contacto in contactos %}
                            {% if contacto.canal and contacto.canal not in canales_unicos %}
                            {% set _ = canales_unicos.append(contacto.canal) %}
                            {% endif %}
                            {% endfor %}
                            {% for canal in canales_unicos %}
                            <option value="{{ canal }}">{{ canal }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label fw-bold">Satisfacción</label>
                        <select class="form-select" id="filterSatisfaccion">
                            <option value="all">Todas</option>
                            <option value="1">1 Estrella</option>
                            <option value="2">2 Estrellas</option>
                            <option value="3">3 Estrellas</option>
                            <option value="4">4 Estrellas</option>
                            <option value="5">5 Estrellas</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label fw-bold">Búsqueda</label>
                        <input type="text" class="form-control" id="searchInput"
                            placeholder="Buscar por nombre, email...">
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-12">
                        <button class="btn btn-outline-secondary btn-sm" id="clearFilters">
                            <i class="bi bi-x-circle me-1"></i>Limpiar Filtros
                        </button>
                    </div>
                </div>
            </div>
        </div>

        {% if contactos | length < 1 %} <h1 class="text-black mb-0 display-4 fw-bold text-center p-5">
            <i class="bi bi-emoji-frown-fill fs-1 text-black m-3"></i> No hay Contactos
            </h1>
            {% else %}
            <!-- Contador de resultados -->
            <div class="d-flex justify-content-between align-items-center mb-3">
                <small class="text-muted" id="resultCount">
                    Mostrando <span id="visibleCount">0</span> de <span id="totalCount">0</span> contactos
                </small>
            </div>

            <div class="table-responsive-lg">
                <table class="table table-bordered table-hover table-striped align-middle">
                    <thead class="table-dark">
                        <tr>
                            <th>ID</th>
                            <th>Nombre</th>
                            <th>Email</th>
                            <th>Celular</th>
                            <th>Empresa</th>
                            <th>Agente asignado</th>
                            <th>Canal</th>
                            <th>Estado</th>
                            <th>Satisfacción</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="contactosTableBody">
                        {% if current_user.rol_id == 1 %}
                        {% for item in contactos %}
                        <tr class="contacto-row" data-estado="{{ item.estado }}" data-canal="{{ item.canal }}"
                            data-satisfaccion="{{ item.satisfaccion }}"
                            data-search="{{ item.nombre }} {{ item.telefono | default('', true) }} {{ item.email }} {{ item.empresa }}"">
                            <td>{{ item.id_contacto }}</td>
                            <td>{{ item.nombre }}</td>
                            <td>{{ item.email }}</td>
                            <td>{{ item.telefono }}</td>
                            <td>{{ item.empresa }}</td>
                            <td>{{ item.agente.username }}</td>
                            <td>{{ item.canal }}</td>
                            <td>
                                <span class=" badge {% if item.estado=='Nuevo' %}bg-primary {% elif
                            item.estado=='En seguimiento' %}bg-warning text-dark {% else %}bg-success{% endif %}">
                            {{ item.estado }}
                            </span>
                            </td>
                            <td>
                                {% if item.satisfaccion %}
                                {% for i in range(1, 6) %}
                                <i class="bi bi-star{% if i <= item.satisfaccion %}-fill text-warning{% endif %}"></i>
                                {% endfor %}
                                {% else %}
                                <span class="text-muted">Sin calificar</span>
                                {% endif %}
                            </td>
                            <td>
                                <a href="/empleado/editar-contacto/{{item.id_contacto}}"
                                    class="btn btn-sm btn-outline-primary" title="Editar">
                                    <i class="bi bi-pencil-fill"></i> Editar
                                </a>
                            </td>
                        </tr>
                        {% endfor %}
                        {% else %}
                        {% set table_contactos = [] %}
                        {% for contacto in contactos %}
                        {% if contacto.id_agente == current_user.id %}
                        {% set _ = table_contactos.append(contacto) %}
                        {% endif %}
                        {% endfor %}

                        {% if table_contactos %}
                        {% for item in table_contactos %}
                        <tr class="contacto-row" data-estado="{{ item.estado }}" data-canal="{{ item.canal }}"
                            data-satisfaccion="{{ item.satisfaccion }}"
                            data-search="{{ item.nombre }} {{ item.telefono | default('', true) }} {{ item.email }} {{ item.empresa }}">
                            <td>{{ item.id_contacto }}</td>
                            <td>{{ item.nombre }}</td>
                            <td>{{ item.email }}</td>
                            <td>{{ item.telefono }}</td>
                            <td>{{ item.empresa }}</td>
                            <td>{{ item.agente.username }}</td>
                            <td>{{ item.canal }}</td>
                            <td>
                                <span class="badge 
                                            {% if item.estado == 'Nuevo' %}bg-primary
                                            {% elif item.estado == 'En seguimiento' %}bg-warning text-dark
                                            {% else %}bg-success{% endif %}">
                                    {{ item.estado }}
                                </span>
                            </td>
                            <td>
                                {% if item.satisfaccion %}
                                {% for i in range(1, 6) %}
                                <i class="bi bi-star{% if i <= item.satisfaccion %}-fill text-warning{% endif %}"></i>
                                {% endfor %}
                                {% else %}
                                <span class="text-muted">Sin calificar</span>
                                {% endif %}
                            </td>
                            <td>

                                {% if item.estado == "Cliente" %}

                                <i class="bi bi-check-circle-fill text-success" title="Cerrada"></i>
                                <small class="text-muted d-block">Completado</small>

                                {% else %}
                                <a href="/empleado/editar-contacto/{{item.id_contacto}}"
                                    class="btn btn-sm btn-outline-primary" title="Editar">
                                    <i class="bi bi-pencil-fill"></i> Editar
                                </a>

                                {% endif %}

                            </td>
                        </tr>
                        {% endfor %}
                        {% else %}
                        <tr>
                            <td colspan="10" class="text-center py-5">
                                <div class="py-4">
                                    <i class="bi bi-people-fill display-4 text-muted mb-3"></i>
                                    <h4 class="text-muted">No hay contactos</h4>
                                    <p class="text-muted mb-0">Los contactos que crees aparecerán aquí</p>
                                </div>
                            </td>
                        </tr>
                        {% endif %}
                        {% endif %}
                    </tbody>
                </table>
            </div>

            <!-- Paginación -->
            <nav aria-label="Paginación de contactos" class="mt-4">
                <ul class="pagination justify-content-center" id="pagination">
                    <!-- La paginación se generará con JavaScript -->
                </ul>
            </nav>
            {% endif %}
    </div>
</div>

<style>
    .contacto-row {
        transition: all 0.3s ease;
    }

    .contacto-row.hidden {
        display: none;
    }

    .page-link {
        cursor: pointer;
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const rows = document.querySelectorAll('.contacto-row');
        const filterEstado = document.getElementById('filterEstado');
        const filterCanal = document.getElementById('filterCanal');
        const filterSatisfaccion = document.getElementById('filterSatisfaccion');
        const searchInput = document.getElementById('searchInput');
        const clearFilters = document.getElementById('clearFilters');
        const resultCount = document.getElementById('resultCount');
        const visibleCount = document.getElementById('visibleCount');
        const totalCount = document.getElementById('totalCount');
        const pagination = document.getElementById('pagination');

        // Configuración de paginación
        const itemsPerPage = 10;
        let currentPage = 1;

        // Inicializar contadores
        totalCount.textContent = rows.length;

        function aplicarFiltrosYBusqueda() {
            const estadoValue = filterEstado.value;
            const canalValue = filterCanal.value;
            const satisfaccionValue = filterSatisfaccion.value;
            const searchValue = searchInput.value.toLowerCase();

            let visibleRows = 0;

            rows.forEach(row => {
                const estado = row.getAttribute('data-estado');
                const canal = row.getAttribute('data-canal');
                const satisfaccion = row.getAttribute('data-satisfaccion');
                const searchText = row.getAttribute('data-search').toLowerCase();

                let mostrar = true;

                // Filtro por estado
                if (estadoValue !== 'all' && estado !== estadoValue) {
                    mostrar = false;
                }

                // Filtro por canal
                if (canalValue !== 'all' && canal !== canalValue) {
                    mostrar = false;
                }

                // Filtro por satisfacción
                if (satisfaccionValue !== 'all' && satisfaccion !== satisfaccionValue) {
                    mostrar = false;
                }

                // Búsqueda
                if (searchValue && !searchText.includes(searchValue)) {
                    mostrar = false;
                }

                if (mostrar) {
                    row.classList.remove('hidden');
                    visibleRows++;
                } else {
                    row.classList.add('hidden');
                }
            });

            // Actualizar contador
            visibleCount.textContent = visibleRows;

            // Actualizar paginación
            actualizarPaginacion(visibleRows);

            // Mostrar primera página
            mostrarPagina(1);
        }

        function actualizarPaginacion(totalItems) {
            const totalPages = Math.ceil(totalItems / itemsPerPage);
            pagination.innerHTML = '';

            if (totalPages <= 1) {
                return;
            }

            // Botón anterior
            const prevLi = document.createElement('li');
            prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
            prevLi.innerHTML = `<a class="page-link" href="#">Anterior</a>`;
            prevLi.addEventListener('click', (e) => {
                e.preventDefault();
                if (currentPage > 1) {
                    mostrarPagina(currentPage - 1);
                }
            });
            pagination.appendChild(prevLi);

            // Números de página
            for (let i = 1; i <= totalPages; i++) {
                const pageLi = document.createElement('li');
                pageLi.className = `page-item ${i === currentPage ? 'active' : ''}`;
                pageLi.innerHTML = `<a class="page-link" href="#">${i}</a>`;
                pageLi.addEventListener('click', (e) => {
                    e.preventDefault();
                    mostrarPagina(i);
                });
                pagination.appendChild(pageLi);
            }

            // Botón siguiente
            const nextLi = document.createElement('li');
            nextLi.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
            nextLi.innerHTML = `<a class="page-link" href="#">Siguiente</a>`;
            nextLi.addEventListener('click', (e) => {
                e.preventDefault();
                if (currentPage < totalPages) {
                    mostrarPagina(currentPage + 1);
                }
            });
            pagination.appendChild(nextLi);
        }

        function mostrarPagina(page) {
            currentPage = page;
            const startIndex = (page - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;

            let visibleIndex = 0;

            rows.forEach(row => {
                if (!row.classList.contains('hidden')) {
                    if (visibleIndex >= startIndex && visibleIndex < endIndex) {
                        row.style.display = '';
                    } else {
                        row.style.display = 'none';
                    }
                    visibleIndex++;
                }
            });

            // Actualizar paginación
            actualizarPaginacion(visibleIndex);
        }

        // Event listeners
        filterEstado.addEventListener('change', aplicarFiltrosYBusqueda);
        filterCanal.addEventListener('change', aplicarFiltrosYBusqueda);
        filterSatisfaccion.addEventListener('change', aplicarFiltrosYBusqueda);
        searchInput.addEventListener('input', aplicarFiltrosYBusqueda);

        clearFilters.addEventListener('click', function () {
            filterEstado.value = 'all';
            filterCanal.value = 'all';
            filterSatisfaccion.value = 'all';
            searchInput.value = '';
            aplicarFiltrosYBusqueda();
        });

        // Inicializar
        aplicarFiltrosYBusqueda();
    });
</script>

{% endblock %}